<?phpinclude_once("dbconfig.php");include_once("functions.php");function addCalendar($st, $et, $sub, $ade){  $ret = array();  $db = new DBConnection();  $conn = $db->get_connection();  $sql = "insert into `jqcalendar` (`Subject`, `StartTime`, `EndTime`, `IsAllDayEvent`) values ('"					.trim($sub)."', '"					.php2MySqlTime(js2PhpTime($st))."', '"					.php2MySqlTime(js2PhpTime($et))."', '"					.trim($ade)."' )";	if(!mysqli_query($conn,$sql)){		$ret['IsSuccess'] = false;		$ret['Msg'] = mysqli_error($conn);  }else{		$ret['IsSuccess'] = true;		$ret['Msg'] = 'add success';		$ret['Data'] = mysqli_insert_id();  }  return $ret;}function addDetailedCalendar($st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();  $db = new DBConnection();  $conn = $db->get_connection();  $sql = "insert into `jqcalendar` (`Subject`, `StartTime`, `EndTime`, `IsAllDayEvent`, `Description`, `Location`, `Color`) values ('"					.trim($sub)."', '"					.php2MySqlTime(js2PhpTime($st))."', '"					.php2MySqlTime(js2PhpTime($et))."', '"					.trim($ade)."', '"					.trim($dscr)."', '"					.trim($loc)."', '"					.trim($color)."' )";	if(!mysqli_query($conn,$sql)){		$ret['IsSuccess'] = false;		$ret['Msg'] = mysqli_error();	}else{		$ret['IsSuccess'] = true;		$ret['Msg'] = 'add success';		$ret['Data'] = mysqli_insert_id();	}  return $ret;}function listCalendarByRange($sd, $ed){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  	$db = new DBConnection();	$conn = $db->get_connection();	$sql = "select * from `jqcalendar` where `StartTime` between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' ORDER BY StartTime ASC";	$handle = mysqli_query($conn,$sql);	while ($row = mysqli_fetch_object($handle)) {	//$ret['events'][] = $row;	//$attends = $row->AttendeeNames;	//if($row->OtherAttendee){	//  $attends .= $row->OtherAttendee;	//}	//echo $row->StartTime;		$ret['events'][] = array(        $row->Id,        $row->Subject,        php2JsTime(mySql2PhpTime($row->StartTime)),        php2JsTime(mySql2PhpTime($row->EndTime)),        $row->IsAllDayEvent,        ($row->IsAllDayEvent!=1 && date("Y-m-d",mySql2PhpTime($row->EndTime))>date("Y-m-d",mySql2PhpTime($row->StartTime))?1:0), //more than one day event        //$row->InstanceType,        0,//Recurring event,        $row->Color,        1,//editable        $row->Location,         ''//$attends      );    }  return $ret;}function listCalendar($day, $type){  $phpTime = js2PhpTime($day);  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday       $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  }  return listCalendarByRange($st, $et);}function updateCalendar($id, $st, $et){  $ret = array();    $db = new DBConnection();    $conn = $db->get_connection();    $sql = "update `jqcalendar` set"						. " `StartTime`='" . php2MySqlTime(js2PhpTime($st)) . "', "						. " `EndTime`='" . php2MySqlTime(js2PhpTime($et)) . "' "						. "where `Id`=" . $id;		if(mysqli_query($conn,$sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }  return $ret;}function updateDetailedCalendar($id, $st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();	$db = new DBConnection();	$conn = $db->get_connection();	$sql = "update `jqcalendar` set"					. " `StartTime`='" . php2MySqlTime(js2PhpTime($st)) . "', "					. " `EndTime`='" . php2MySqlTime(js2PhpTime($et)) . "', "					. " `Subject`='" . trim($sub) . "', "					. " `Isalldayevent`='" . trim($ade) . "', "					. " `Description`='" . trim($dscr) . "', "					. " `Location`='" . trim($loc) . "', "					. " `Color`='" . trim($color) . "' "					. "where `Id`=" . $id;	if(mysqli_query($conn,$sql)==false){		$ret['IsSuccess'] = false;		$ret['Msg'] = mysqli_error();	}else{		$ret['IsSuccess'] = true;		$ret['Msg'] = 'Succefully';	}  return $ret;}function removeCalendar($id){  $ret = array();	$db = new DBConnection();	$conn = $db->get_connection();	$sql = "delete from `jqcalendar` where `Id`=" . $id;	if(mysqli_query($conn,$sql)==false){		$ret['IsSuccess'] = false;		$ret['Msg'] = mysqli_error();	}else{		$ret['IsSuccess'] = true;		$ret['Msg'] = 'Succefully';	}  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];switch ($method) {	case "add":		$ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"]);		break;	case "list":		$ret = listCalendar($_POST["showdate"], $_POST["viewtype"]);		break;	case "update":		$ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"]);		break; 	case "remove":		$ret = removeCalendar($_POST["calendarId"]);		break;	case "adddetails":		$st = $_POST["stpartdate"] . " " . $_POST["stparttime"];		$et = $_POST["etpartdate"] . " " . $_POST["etparttime"];		if(isset($_GET["id"])){			$ret = updateDetailedCalendar($_GET["id"], $st, $et, 			$_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"], 			$_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);		}else{			$ret = addDetailedCalendar($st, $et,$_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],$_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);		}        		break; }echo json_encode($ret); ?>